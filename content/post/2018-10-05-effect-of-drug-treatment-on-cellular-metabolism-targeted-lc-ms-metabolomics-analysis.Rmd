---
title: Effect of drug treatment on cellular metabolism (targeted LC/MS metabolomics
  analysis)
author: Darya Akimova
date: '2018-10-05'
slug: effect-of-drug-treatment-on-cellular-metabolism-targeted-lc-ms-metabolomics-analysis
categories:
  - R
  - metabolomics
tags:
  - exploratory analysis
  - linear regression
description: ''
topics: []
output:
  blogdown::html_page:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# Introduction

This project is a walkthrough of a metabolomics analysis project that involves:

* Exploratory data anaysis - evaluation distribtuions, missing values, data structure
* Surrogate variable analysis using the `sva` package, in order to detect and account for unexpected batch effects
* Linear regression on a categorial variable and on surrogate variables identified by the `sva` package, followed by statistical significance analysis, all using the `limma` package
* Visualization of data cleaned of surrogate variables (residuals)
* Some pathway analysis and interetation of significant features 

The setup section inovlves the importing of packages, data, and the functions that will be used throughout this analysis. This section can be skipped using the table of contents above.

The following document is an example of my typical analysis procedure of LC/MS small molecule metabolomics data. I don't want to get too bogged down in the technical details of the experiment. The most important details to know is that these datasets are comporised of samples collected from cells I had grown and had treated half with a drug, and half was not treated. There's also two datasets because each sample was analyzed twice, once for each intrument mode (positive and negative). This is necessary because each instrument mode is better at detecting certain classes of compounds/chemicals than others, although some compounds can be detected in both. One can take advantage of this as a method of confirmation.


A house database with was applied to the raw data files using a program known as Agilent Profinder in order to extract the abundances of about 100-150 tentatively identified metabolites. There are open source options for this step, such as the package `xcms`, but in my lab, since we have access to Profinder, that tends to be the software of choice. 

As a brief intro to LC/MS analysis, the LC portion is a method of separating compounds out over time, which gives some information about the structure and the nature of the compound, and also ensures that all compounds do not hit the detector at once and overwhelm the system. Mass spectrometers are very sensitive instruments and if too many compounds are sent in to the instument at once, the abunance readings would be highl inaccurate.

Another thing that will pop up throughout this, is the idea of "positive" and "negative" mode. This has to do with how the instrument detects molecules. Mass spectrometers can only detect and measure charged molecules, but molecules can have either positive or negative charges. Negative mode simply means that the instrument only detects and measures negatively charged molecules, while positive mode is for positively-charged molecules. Some molecules can be measured in either mode, and the data from both positive and negative mode can be used a corroborative evidence. But some molecules can only be detected in one mode or the other. Methodology can vary from lab to lab, but my lab usually runs each sample at least twice, once for each MS mode.  

# Setup

## Packages:

```{r packages, comment=NA}
library(tidyverse)
library(cowplot)
library(GGally)
library(heatmaply)
library(sva)
library(limma)
library(biobroom)
library(ggridges)
```

## Data:

### Abundances:

There are two data files associated with this analysis:

* Readings from the cells in negative MS mode
* Readings from the cells in positive MS mode

In general, the media tends to be less useful 

```{r import, comment=NA}
# compound abundances #
neg.raw <- read_csv("./data/cells_target_negmode.csv")
pos.raw <- read_csv("./data/cells_target_posmode.csv")
# Kegg/other ID reference #
cmpnd.id.db <- read_csv("./data/anp_db_compound_kegg.csv")
```

## Functions:

```{r functions, comment=NA}
ReplaceNAwMinLogTransform <- function(raw.dataframe, start.prefix) {
  # Function to replace any NAs in each column with the minimum for that column, 
  # separately for each data.set (patient and dabase samples separately)
  #
  # Returns: returns data frame(? check on this) with only the values bound by the function args
  # 
  smpls <- raw.dataframe %>%
    filter(Group == "sample") %>% 
    dplyr::select(starts_with(start.prefix))
  smpls.min <- lapply(smpls, min, na.rm = TRUE)
  # replace the missing values in the real samples with the minimum of the samples
  # then take the log
  smpls.noNA <- raw.dataframe  %>%
    filter(Group == "sample") %>% 
    dplyr::select(Samples:Experiment) %>%
    bind_cols(
      smpls %>%
        replace_na(replace = smpls.min) %>% 
        log2()
      )
  # replace the missing values in solv and empty samples with 1 - for PCA analysis
  # then take the log
  other.min <- setNames(
    as.list(
      rep(1, ncol(
        raw.dataframe %>% 
          dplyr::select(starts_with(start.prefix))))
      ),
    colnames(raw.dataframe %>% dplyr::select(starts_with(start.prefix)))
                )
  other.num.log <- raw.dataframe %>%
    filter(Group == "solv" | Group == "empty") %>% 
    dplyr::select(Samples:Experiment) %>%
    bind_cols(
      raw.dataframe %>% 
        filter(Group == "solv" | Group == "empty") %>% 
        dplyr::select(starts_with(start.prefix)) %>%
        replace_na(replace = other.min) %>% 
        log2()
      )
  # combine them together back into one data frame
  all.noNA <- smpls.noNA %>% 
    bind_rows(other.num.log)
}

MissingPerSamplePlot <- function(raw.data, start.string) {
  # Counts the number of missing/NA values per sample and
  # percent compounds missing out of total number of compounds per sample
  # Then passes the result into a vertical bar plot, where each 
  # bar represents a single sample and the size of the bar 
  # is the % of compounds missing
  counted.na <- raw.data %>%
  select(starts_with(start.string)) %>% 
  mutate(
    count.na = apply(., 1, function(x) sum(is.na(x))),
    percent.na = (count.na / ncol(raw.data %>% select(starts_with(start.string)))) * 100
    ) %>%
  dplyr::select(count.na, percent.na) %>%
  bind_cols(
    raw.data %>% 
      select(Samples, Group)
      ) %>% 
  arrange(percent.na) %>% 
  mutate(f.order = factor(Samples, levels = Samples))
counted.na %>% 
  ggplot(aes(x = f.order, y = percent.na, fill = Group)) +
  geom_bar(stat = "identity") +
  geom_hline(yintercept = 20, color = "gray", size = 1, alpha = 0.8) +
  coord_flip()+
  xlab("Samples") +
  ylab("Percent missing values in sample") +
  theme(axis.text.y = element_text(size = 6)) 
}
MissingPerCompound <- function(raw.data, start.string){
  # Function to count in how many sample each compound is missing
  # Also calculates the % missing:
  # (num of samples per compound) * 100 / (tot num of samples)
  raw.data %>% 
  filter(Group == "sample") %>% 
  select(Samples, starts_with(start.string)) %>% 
  gather(key = "Compound", value = "Abundance", -Samples) %>% 
  group_by(Compound) %>% 
  summarise(
    na_count = sum(is.na(Abundance)),
    n_samples = n(),
    percent_na = (na_count / n_samples * 100)
    ) %>% 
  filter(na_count > 0) %>% 
  arrange(desc(percent_na))
}


HeatmapPrep <- function(raw.data, group, start.prefix){
  x <- raw.data %>% 
    filter(Group == group) %>% 
    select(starts_with(start.prefix)) %>% 
    scale(center = TRUE, scale = TRUE) %>% 
    as.matrix() 
  x.rownames <- raw.data %>% 
        filter(Group == group) %>% 
        select(Samples)
  row.names(x) <- x.rownames$Samples
  return(x)
}

HeatmapPrepAlt <- function(raw.data, start.prefix){
  x <- raw.data %>% 
    select(starts_with(start.prefix)) %>% 
    scale(center = TRUE, scale = TRUE) %>% 
    as.matrix() 
  row.names(x) <- raw.data$Samples
  return(x)
}
```


# Exploratory Analysis


## NA per sample and per compound

Q: Do any of the cell or media samples have greater than 20% compound abundances missing (NA)?

```{r missing_per_sample_plots, comment=NA}
MissingPerSamplePlot(neg.raw, "ANPnC") +
  ggtitle("Missing Per Sample\nPost Drug Treatment\nNeg Mode")
MissingPerSamplePlot(pos.raw, "ANPpC") +
  ggtitle("Missing Per Sample\nPost Drug Treatment\nPos Mode")
```

A: No, sample files across all 4 datasets have bery few missing compound abundances. The solvent and "empty" media samples have greater than 20% missing compounds, but that's not an issue for the actual analysis itself.


Q: Are any of the compounds greater than 20% missing in any of the datasets? If there are any, they will be excluded from analysis. 

For cell metabolomics analysis, which tend to provide ample biological material, compounds should rarely be missing/undetectable. A high number of NA across sample files may indicate an unreliable compound, in which case it may be best to not consider it in analysis.

Note: The `MissingPerCompound` function considers only the `Group == "sample"` samples.

```{r percent_missing_per_compound}
## Missing per Compound ## 
MissingPerCompound(neg.raw, "ANPnC") %>% 
  filter(percent_na > 20)
(pos.cmpnd.to.excl <- MissingPerCompound(pos.raw, "ANPpC") %>% 
  filter(percent_na > 20))
```

A: No compounds need to be excluded from the Neg Mode dataset, but 1 compound will be excluded from the Pos Mode dataset. 


## Empty/Solv vs Sample Files

### Background

Good experimental design often involves including certain types of samples known as negative and positive controls. Positive controls, samples where you know for sure that your target or whatever you're measuring is present, are a verification that your technique or instrument are able to detect and/or quantify your target correctly. Negative controls, on the other hand, are used to make sure that the signal of interest is real and not an artifact of the method. 

In the case of this analysis, there are no positive controls, but there are two sets of negative controls: 

* `solv`: These are "solvent" samples - samples of just the chemical solvent that the biological samples are dissolved in for analysis. Any compounds detected in these samples are probably artifacts from experimental tools themselves, the sample vials or plastic pipettes for example.
* `empty`: This group of samples are derived by treating tissue culture wells the same as the experimental cell samples, but these had no actual cells grown in them. These samples are a control for the sample washing and preparation process. Cells are typically grown in very nutrient-rich liquid broth/media that is hard to get rid of completely. If any compound is present in high abundance in these samples, it may represent technical variation that can obscure biological variation.

### Negative Mode


```{r empty_solv_cell_neg}
neg.raw.grp.mean <- neg.raw %>% 
  group_by(Group) %>% 
  summarize_at(vars(matches("ANPnC")), mean, na.rm = TRUE) %>% 
  gather(key = "Compound", value = "Grp_mean_abun", -Group)
neg.raw.grp.mean %>% 
  ggplot(aes(log2(Grp_mean_abun), color = Group)) +
  geom_density(size = 2, alpha = 0.8)
neg.raw.grp.mean.order <- neg.raw.grp.mean %>% 
  filter(Group == "sample") %>% 
  arrange(Grp_mean_abun)
neg.raw %>% 
  select(Samples, Group, starts_with("ANPnC")) %>% 
  gather("Compound", value = "Abundance", -c(Samples, Group)) %>% 
  mutate(Cmpnd_sort = factor(Compound, levels = neg.raw.grp.mean.order$Compound)) %>% 
  ggplot(aes(Cmpnd_sort, log2(Abundance), color = Group, group = Samples)) + 
  geom_line(alpha = 0.25, size = 1) + 
  #geom_point(size = 1, alpha = 0.8)
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  xlab("Compound") +
  geom_line(
    data = neg.raw.grp.mean %>% 
      mutate(Cmpnd_sort = factor(Compound, levels = neg.raw.grp.mean.order$Compound)), 
    aes(Cmpnd_sort, log2(Grp_mean_abun), color = Group, group = Group),
    size = 1
    )
neg.raw.grp.mean %>% 
  mutate(Cmpnd_sort = factor(Compound, levels = neg.raw.grp.mean.order$Compound)) %>% 
  ggplot(aes(Cmpnd_sort, log2(Grp_mean_abun), color = Group, group = Group)) +
  geom_point(size = 1, alpha = 0.8) +
  geom_line(alpha = 0.8) +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  xlab("Compound") +
  ylab("log2(Sample Type Mean)")
neg.raw.grp.diff <- neg.raw.grp.mean %>% 
  spread(Group, Grp_mean_abun) %>% 
  mutate(
    smpl_empty_diff = sample / empty,
    smpl_solv_diff = sample / solv,
    empty_solv_diff = empty / solv
    )
neg.raw.grp.diff %>% 
  ggplot(aes(log2(smpl_empty_diff))) +
  geom_histogram(bins = 50)
neg.raw.grp.diff %>% 
  ggplot(aes(log2(smpl_solv_diff))) +
  geom_histogram(bins = 50)
neg.raw.grp.diff %>% 
  ggplot(aes(log2(smpl_empty_diff), log2(smpl_solv_diff))) +
  geom_point(size = 2, alpha = 0.5) +
  xlim(-3, 13.5) +
  ylim(-3, 13.5) +
  # abline in pink
  geom_abline(intercept = 0, slope = 1, color =  "#CC79A7", size = 2, alpha = 0.6) +
  # lm line in green
  geom_smooth(method = "lm", color = "#009E73", size = 2, alpha = 0.6, se = FALSE) +
  xlab("log2([Sample Compound Mean] / [Empty Compound Mean])") +
  ylab("log2([Sample Compound Mean] / [Solvent Compound Mean])") +
  ggtitle("Background signal\nRaw Data / Cells / Neg Mode")
# include compounds with FC > 2.5 or FC is NA (indication of NA in solv or empty)
neg.cmpnd.to.incl <- neg.raw.grp.diff %>% 
  filter((smpl_solv_diff > 2.5 & smpl_empty_diff > 2.5) | is.na(smpl_solv_diff) | is.na(smpl_empty_diff))
nrow(neg.raw.grp.diff)
nrow(neg.cmpnd.to.incl)
```

In the end, 179 out of the 211 features will be included in the final analysis.


### Positive Mode

The same procedure as above can be applied to the positive mode data, but I'm only going to show the results because the code is redundant.


```{r empty_solv_cell_pos, comment=NA, echo=FALSE}
pos.raw.grp.mean <- pos.raw %>% 
  group_by(Group) %>% 
  summarize_at(vars(matches("ANPpC")), mean, na.rm = TRUE) %>% 
  gather(key = "Compound", value = "Grp_mean_abun", -Group)
pos.raw.grp.mean %>% 
  ggplot(aes(log2(Grp_mean_abun), color = Group)) +
  geom_density(size = 2, alpha = 0.8)
pos.raw.grp.mean.order <- pos.raw.grp.mean %>% 
  filter(Group == "sample") %>% 
  arrange(Grp_mean_abun)
pos.raw.grp.mean %>% 
  mutate(Cmpnd_sort = factor(Compound, levels = pos.raw.grp.mean.order$Compound)) %>% 
  ggplot(aes(Cmpnd_sort, log2(Grp_mean_abun), color = Group, group = Group)) +
  geom_point(size = 1, alpha = 0.8) +
  geom_line(alpha = 0.8) +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  xlab("Compound") +
  ylab("log2(Sample Type Mean)")
pos.raw.grp.diff <- pos.raw.grp.mean %>% 
  spread(Group, Grp_mean_abun) %>% 
  mutate(
    smpl_empty_diff = sample / empty,
    smpl_solv_diff = sample / solv,
    empty_solv_diff = empty / solv
    )
pos.raw.grp.diff %>% 
  ggplot(aes(log2(smpl_empty_diff))) +
  geom_histogram(bins = 50)
pos.raw.grp.diff %>% 
  ggplot(aes(log2(smpl_solv_diff))) +
  geom_histogram(bins = 50)
pos.raw.grp.diff %>% 
  ggplot(aes(log2(smpl_empty_diff), log2(smpl_solv_diff))) +
  geom_point(size = 2, alpha = 0.5) +
  xlim(-1, 15) +
  ylim(-1, 15) +
  geom_abline(intercept = 0, slope = 1, color =  "#CC79A7", size = 2, alpha = 0.6) +
  geom_smooth(method = "lm", color = "#009E73", size = 2, alpha = 0.6, se = FALSE) +
  xlab("log2([Sample Compound Mean] / [Empty Compound Mean])") +
  ylab("log2([Sample Compound Mean] / [Solvent Compound Mean])") +
  ggtitle("Background signal\nRaw Data / Cells / Pos Mode")
# include compounds with FC > 2.5 or FC is NA (indication of NA in solv or empty)
pos.cmpnd.to.incl <- pos.raw.grp.diff %>% 
  filter((smpl_solv_diff > 2.5 & smpl_empty_diff > 2.5) | is.na(smpl_solv_diff) | is.na(smpl_empty_diff)) %>% 
  filter(!(Compound %in% pos.cmpnd.to.excl$Compound))
nrow(pos.raw.grp.diff)
nrow(pos.cmpnd.to.incl)
```


# Data prep and prelim analysis


## NA replacement and log transform


```{r min_na_rpl_log_transform, comment=NA}
# replace missing with minimum for each Group in each dataset and log2() transform the data:
# exclude compound that have a >20% NA count across samples
neg.noNA <- neg.raw %>% 
  select(Samples:Experiment, one_of(neg.cmpnd.to.incl$Compound)) %>% 
  ReplaceNAwMinLogTransform("ANPnC")
pos.noNA <- pos.raw %>% 
  select(Samples:Experiment, one_of(pos.cmpnd.to.incl$Compound)) %>% 
  ReplaceNAwMinLogTransform("ANPpC")
```


## Distribution plots:

### Negative

```{r distribution_plots_neg, comment=NA}
neg.noNA.gathered <- neg.noNA %>% 
  gather(
    key = "Metabolite", "Abundance", 
    which(colnames(neg.noNA) == "ANPnC1"):ncol(neg.noNA)
    )
neg.noNA.gathered %>% 
  ggplot(aes(Samples, Abundance, fill = Group)) +
  geom_boxplot() +
  geom_boxplot(aes(color = Group), fatten = NULL, fill = NA, coef = 0, outlier.alpha = 0, show.legend = FALSE) +
  theme(axis.text.x = element_text(angle = 90))

neg.noNA.gathered %>% 
  ggplot(aes(Samples, Abundance, fill = Treatment)) +
  geom_boxplot() +
  geom_boxplot(aes(color = Treatment), fatten = NULL, fill = NA, coef = 0, outlier.alpha = 0, show.legend = FALSE) +
  theme(axis.text.x = element_text(angle = 90))

neg.summarized.abun <- neg.noNA.gathered %>% 
  group_by(Samples, Group, Treatment, Plate, Experiment) %>% 
  summarize(
    mean_Abun = mean(Abundance),
    med_Abun = median(Abundance)
    )
neg.summarized.abun %>% 
  ggplot(aes(mean_Abun)) +
  geom_histogram()
neg.summarized.abun %>% 
  ggplot(aes(med_Abun)) +
  geom_histogram()

neg.noNA.gathered %>% 
  ggplot(aes(y = Samples, x = Abundance, fill = Group)) + 
  geom_density_ridges(scale = 20) +
  theme_ridges() +
  scale_y_discrete(expand = c(0.01, 0))

neg.noNA.gathered %>% 
  ggplot(aes(y = Group, x = Abundance, fill = Group)) + 
  geom_density_ridges(scale = 2.5) +
  theme_ridges() +
  scale_y_discrete(expand = c(0.01, 0))

neg.noNA.gathered %>%
  ggplot(aes(Abundance, group = Samples, color= Group)) +
  geom_density(alpha = 0.8, size = 0.75)
neg.noNA.gathered %>%
  ggplot(aes(Abundance, group = Samples, color = Group)) +
  geom_density(alpha = 0.8, size = 0.75) +
  facet_wrap(~ Treatment)
neg.noNA.gathered %>%
  ggplot(aes(Abundance, group = Samples, color = Experiment)) +
  geom_density(alpha = 0.8, size = 0.75)
neg.noNA.gathered %>%
  ggplot(aes(Abundance, group = Samples, color = Experiment)) +
  geom_density(alpha = 0.6, size = 0.75) +
  facet_wrap(~ Treatment)
```


### Positive

```{r distribution_plots_pos, comment=NA}
pos.noNA.gathered <- pos.noNA %>% 
  gather(
    key = "Metabolite", "Abundance", 
    which(colnames(pos.noNA) == "ANPpC1"):ncol(pos.noNA)
    )
pos.noNA.gathered %>% 
  ggplot(aes(Samples, Abundance, fill = Group)) +
  geom_boxplot() +
  geom_boxplot(aes(color = Group), fatten = NULL, fill = NA, coef = 0, outlier.alpha = 0, show.legend = FALSE) +
  theme(axis.text.x = element_text(angle = 90))

pos.noNA.gathered %>% 
  ggplot(aes(Samples, Abundance, fill = Treatment)) +
  geom_boxplot() +
  geom_boxplot(aes(color = Treatment), fatten = NULL, fill = NA, coef = 0, outlier.alpha = 0, show.legend = FALSE) +
  theme(axis.text.x = element_text(angle = 90))

pos.summarized.abun <- pos.noNA.gathered %>% 
  group_by(Samples, Group, Treatment, Plate, Experiment) %>% 
  summarize(
    mean_Abun = mean(Abundance),
    med_Abun = median(Abundance)
    )
pos.summarized.abun %>% 
  ggplot(aes(mean_Abun)) +
  geom_histogram()
pos.summarized.abun %>% 
  ggplot(aes(med_Abun)) +
  geom_histogram()

pos.noNA.gathered %>% 
  ggplot(aes(y = Samples, x = Abundance, fill = Group)) + 
  geom_density_ridges(scale = 20) +
  theme_ridges() +
  scale_y_discrete(expand = c(0.01, 0))

pos.noNA.gathered %>% 
  ggplot(aes(y = Group, x = Abundance, fill = Group)) + 
  geom_density_ridges(scale = 2.5) +
  theme_ridges() +
  scale_y_discrete(expand = c(0.01, 0))

pos.noNA.gathered %>%
  ggplot(aes(Abundance, group = Samples, color= Group)) +
  geom_density(alpha = 0.8, size = 0.75)
pos.noNA.gathered %>%
  ggplot(aes(Abundance, group = Samples, color = Group)) +
  geom_density(alpha = 0.8, size = 0.75) +
  facet_wrap(~ Treatment)
pos.noNA.gathered %>%
  ggplot(aes(Abundance, group = Samples, color = Experiment)) +
  geom_density(alpha = 0.8, size = 0.75)
pos.noNA.gathered %>%
  ggplot(aes(Abundance, group = Samples, color = Experiment)) +
  geom_density(alpha = 0.6, size = 0.75) +
  facet_wrap(~ Treatment)
```


## Exploratory PCA 

### Background

Principal component analysis is a commonly used dimension reduction technique that is often used in "omics" studies to visualize relationships in high dimensional data. There are far more detailed explanations of this machine learning technique available elsewhere, but in brief, it extracts the common variance between compounds across samples and combines the information into new variable, or principal components. In a way, it is a projection of high dimensional data onto a lower-dimensional axis (?). The main idea here, is that many metabolites (or any type of features) are related in some way, and that relationship can be simplified with some loss of information, but at the advantage of ease of visualization. 

### Negative Mode

```{r exploratory_pca_neg, comment=NA}
# All Samples #
neg.full.pca <- neg.noNA %>% 
  select(starts_with("ANPnC")) %>% 
  mutate_all(scale, center = TRUE, scale = FALSE) %>% 
  as.matrix() %>% 
  prcomp()
neg.full.pca.x <- as.data.frame(neg.full.pca$x)
row.names(neg.full.pca.x) <- neg.noNA$Samples
neg.full.pca.x <- neg.full.pca.x %>% 
  bind_cols(neg.noNA %>% select(Group:Experiment))
neg.full.pca.x %>% 
  ggplot(aes(x = PC1, y = PC2, color = Group)) +
  geom_point(size = 2, alpha = 0.8) +
  xlab("PC1 (89.9% Var)") +
  ylab("PC2 (3.5%)")

# Experimental Samples Only #
neg.smpl.pca <- neg.noNA %>% 
  filter(Group == "sample") %>% 
  select(starts_with("ANPnC")) %>% 
  mutate_all(scale, center = TRUE, scale = FALSE) %>% 
  as.matrix() %>% 
  prcomp()
neg.smpl.pca.x <- as.data.frame(neg.smpl.pca$x)
neg.smpl.pca.x <- neg.smpl.pca.x %>% 
  bind_cols(
    neg.noNA %>% 
      filter(Group == "sample") %>% 
      select(Samples, Group:Experiment)
  )
row.names(neg.smpl.pca.x) <- neg.smpl.pca.x$Samples
neg.smpl.pca.x %>% 
  ggplot(aes(x = PC1, y = PC2, color = Treatment)) +
  geom_point(size = 4, alpha = 0.8) +
  xlab("PC1 (34.3% Var)") +
  ylab("PC2 (23.8%)")
neg.smpl.pca.x %>% 
  ggplot(aes(x = PC3, y = PC4, color = Treatment)) +
  geom_point(size = 4, alpha = 0.8) +
  xlab("PC3 (16.6% Var)") +
  ylab("PC4 (7.1%)")
```


### Postive Mode


```{r exploratory_pca_pos, comment=NA}
# All Samples #
pos.full.pca <- pos.noNA %>% 
  select(starts_with("ANPpC")) %>% 
  mutate_all(scale, center = TRUE, scale = FALSE) %>% 
  as.matrix() %>% 
  prcomp()
pos.full.pca.x <- as.data.frame(pos.full.pca$x)
row.names(pos.full.pca.x) <- pos.noNA$Samples
pos.full.pca.x <- pos.full.pca.x %>% 
  bind_cols(pos.noNA %>% select(Group:Experiment))
pos.full.pca.x %>% 
  ggplot(aes(x = PC1, y = PC2, color = Group)) +
  geom_point(size = 2, alpha = 0.8) +
  xlab("PC1 (89.5% Var)") +
  ylab("PC2 (4.5%)")

# Experimental Samples Only #
pos.smpl.pca <- pos.noNA %>% 
  filter(Group == "sample") %>% 
  select(starts_with("ANPpC")) %>% 
  mutate_all(scale, center = TRUE, scale = FALSE) %>% 
  as.matrix() %>% 
  prcomp()
pos.smpl.pca.x <- as.data.frame(pos.smpl.pca$x)
pos.smpl.pca.x <- pos.smpl.pca.x %>% 
  bind_cols(
    pos.noNA %>% 
      filter(Group == "sample") %>% 
      select(Samples, Group:Experiment)
  )
row.names(pos.smpl.pca.x) <- pos.smpl.pca.x$Samples
pos.smpl.pca.x %>% 
  ggplot(aes(x = PC1, y = PC2, color = Treatment)) +
  geom_point(size = 4, alpha = 0.8) +
  xlab("PC1 (57.5% Var)") +
  ylab("PC2 (19.6%)")
pos.smpl.pca.x %>% 
  ggplot(aes(x = PC3, y = PC4, color = Treatment)) +
  geom_point(size = 4, alpha = 0.8) +
  xlab("PC3 (7.2% Var)") +
  ylab("PC4 (4.7%)")
```


# Surrogate Variable Analsysis and Signifiance Testing using Limma


## Negative Mode

```{r cell_neg_stat, comment=NA}
# sample prep
neg.smpl.data <- neg.noNA %>% 
    filter(Group == "sample")
neg.data.for.sva <- as.matrix(
  neg.smpl.data[, which(
    colnames(neg.smpl.data) == "ANPnC1"
    ):ncol(neg.smpl.data)]
  )
row.names(neg.data.for.sva) <- neg.smpl.data$Samples
neg.data.for.sva <- t(neg.data.for.sva)
# pheno prep
neg.data.pheno <- as.data.frame(neg.smpl.data[, 4:6])
row.names(neg.data.pheno) <- neg.smpl.data$Samples
# sva calculation
neg.mod.drug <- model.matrix(~ as.factor(Treatment), data = neg.data.pheno)
neg.mod0 <- model.matrix(~ 1, data = neg.data.pheno)
neg.sv <- sva(neg.data.for.sva, neg.mod.drug, neg.mod0)

# original method
neg.d <- model.matrix( ~ 0 + as.factor(Treatment), data = neg.data.pheno)
colnames(neg.d) <- levels(as.factor(neg.data.pheno$Treatment))
neg.d.sv <- cbind(neg.d, neg.sv$sv)
colnames(neg.d.sv)[3:5] <- c("S1", "S2", "S3")

plot(neg.smpl.pca.x$PC1, neg.d.sv[, 3])

# method 1
neg.cont.mat <- makeContrasts("cntrl-drug", levels = c("cntrl", "drug", "S1", "S2", "S3"))
row.names(neg.cont.mat) <- NULL
neg.top.table <- lmFit(neg.data.for.sva, neg.d.sv) %>% 
  contrasts.fit(neg.cont.mat) %>% 
  eBayes() %>% 
  topTable(adjust = "bonferroni", p.value = 0.05, n = nrow(neg.data.for.sva))
  
# method 2
neg.d.sv.test <- cbind(neg.mod.drug, neg.sv$sv)  
colnames(neg.d.sv.test) <- c("cntrl", "DRUGvsCNTRL", "S1", "S2", "S3")
neg.top.table.test <- lmFit(neg.data.for.sva, neg.d.sv.test) %>% 
  eBayes() %>% 
  topTable(coef = "DRUGvsCNTRL", adjust = "bonferroni", p.value = 0.05, n = nrow(neg.data.for.sva))
  

neg.top.w.info <- neg.top.table.test %>% 
    rownames_to_column("compound_short") %>% 
    mutate(
      drug_div_cntrl = round(2 ^ logFC, 2),
      change_w_drug = ifelse(drug_div_cntrl < 1, "down", "up")
      ) %>% 
    filter(drug_div_cntrl > 1.2 | drug_div_cntrl < 0.83) %>%  
    arrange(change_w_drug, desc(drug_div_cntrl))
neg.top.w.info %>% 
  select(compound_short, change_w_drug, drug_div_cntrl)
  
### Plotting ###
  neg.surr.var <- as.data.frame(neg.sv$sv)
  colnames(neg.surr.var) <- c("S1", "S2", "S3")
  neg.gathered <- neg.noNA %>%
    filter(Group == "sample") %>% 
    bind_cols(neg.surr.var) %>% 
    select(Samples, Treatment, S1:S3, starts_with("ANPnC")) %>% 
    gather(key = "Compound", value = "Abundance", ANPnC1:ANPnC99)
  neg.nested <- neg.gathered %>% 
    group_by(Compound) %>% 
    nest() %>% 
    mutate(model = map(data, ~lm(Abundance ~ S1 + S2 + S3, data = .))) %>% 
    mutate(augment_model = map(model, augment))
  neg.modSV.resid <- neg.nested %>% 
    unnest(data, augment_model) %>% 
    select(Samples, Treatment, Compound, .resid) %>% 
    spread(Compound, .resid) 
```  


```{r fig.height = 10, fig.width = 8}
neg.modSV.resid %>% 
  select(Samples, one_of(neg.top.w.info$compound_short)) %>% 
  HeatmapPrepAlt("ANPnC") %>% 
  t() %>% 
  heatmap(col = magma(10), scale = "none")
```


```{r fig.width = 8, fig.height=10}
neg.modSV.resid %>% 
  select(Samples, one_of(neg.top.w.info$compound_short)) %>% 
  HeatmapPrepAlt("ANPnC") %>% 
  t() %>% 
  heatmaply(
    colors = viridis(n = 10, option = "magma"), 
    xlab = "Samples", ylab = "Compounds",
    main = "Statistically significant compounds\nAfter Drug Treatment / Neg Mode",
    margins = c(50, 50, 75, 30)
    )
``` 

  
## Positive Mode


```{r cell_pos_stat, comment = NA}
# sample prep
pos.smpl.data <- pos.noNA %>% 
    filter(Group == "sample")
pos.data.for.sva <- as.matrix(
  pos.smpl.data[, which(
    colnames(pos.smpl.data) == "ANPpC1"
    ):ncol(pos.smpl.data)]
  )
row.names(pos.data.for.sva) <- pos.smpl.data$Samples
pos.data.for.sva <- t(pos.data.for.sva)
# pheno prep
pos.data.pheno <- as.data.frame(pos.smpl.data[, 4:6])
row.names(pos.data.pheno) <- pos.smpl.data$Samples
# sva calculation
pos.mod.drug <- model.matrix(~ as.factor(Treatment), data = pos.data.pheno)
pos.mod0 <- model.matrix(~ 1, data = pos.data.pheno)
pos.sv <- sva(pos.data.for.sva, pos.mod.drug, pos.mod0)
# method 2
pos.d.sv.test <- cbind(pos.mod.drug, pos.sv$sv)  
colnames(pos.d.sv.test) <- c("cntrl", "DRUGvsCNTRL", "S1", "S2")
pos.top.table.test <- lmFit(pos.data.for.sva, pos.d.sv.test) %>% 
  eBayes() %>% 
  topTable(coef = "DRUGvsCNTRL", adjust = "bonferroni", p.value = 0.05, n = nrow(pos.data.for.sva))
pos.top.w.info <- pos.top.table.test %>% 
    rownames_to_column("compound_short") %>% 
    mutate(
      drug_div_cntrl = round(2 ^ logFC, 2),
      change_w_drug = ifelse(drug_div_cntrl < 1, "down", "up")
      ) %>% 
    filter(drug_div_cntrl > 1.2 | drug_div_cntrl < 0.83) %>%  
    arrange(change_w_drug, desc(drug_div_cntrl))
pos.top.w.info %>% 
  select(compound_short, change_w_drug, drug_div_cntrl)
  
### Plotting ###
  pos.surr.var <- as.data.frame(pos.sv$sv)
  colnames(pos.surr.var) <- c("S1", "S2")
  pos.gathered <- pos.noNA %>%
    filter(Group == "sample") %>% 
    bind_cols(pos.surr.var) %>% 
    select(Samples, Treatment, S1:S2, starts_with("ANPpC")) %>% 
    gather(key = "Compound", value = "Abundance", ANPpC1:ANPpC98)
  pos.nested <- pos.gathered %>% 
    group_by(Compound) %>% 
    nest() %>% 
    mutate(model = map(data, ~lm(Abundance ~ S1 + S2, data = .))) %>% 
    mutate(augment_model = map(model, augment))
  pos.modSV.resid <- pos.nested %>% 
    unnest(data, augment_model) %>% 
    select(Samples, Treatment, Compound, .resid) %>% 
    spread(Compound, .resid)
```

```{r fig.width = 8, fig.height=10}
pos.modSV.resid %>% 
  select(Samples, one_of(pos.top.w.info$compound_short)) %>% 
  HeatmapPrepAlt("ANPpC") %>% 
  t() %>% 
  heatmap(col = magma(10), scale = "none")
```

```{r fig.width = 8, fig.height=10}
pos.modSV.resid %>% 
  select(Samples, one_of(pos.top.w.info$compound_short)) %>% 
    HeatmapPrepAlt("ANPpC") %>% 
    t() %>% 
    heatmaply(
      colors = viridis(n = 10, option = "magma"), 
      xlab = "Samples", ylab = "Compounds",
      main = "Statistically significant compounds\nExperiment / Cells / pos Mode",
      margins = c(50, 50, 75, 30)
      )
```
  
# Interpretation